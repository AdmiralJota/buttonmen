<!DOCTYPE html>
<!--
    This document should be written in polyglot HTML5/XHTML5, and therefore
    should run when served either as text/html or application/xhtml+xml.
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
    <head>
        <meta charset="utf-8" />
        <title>JSON Testing</title>
        <link rel="stylesheet" href="api.css" />
    </head>
    <body>
        <p>
            <button id="fetch">Fetch JSON info!</button><br />
            <textarea id="result" style="width:500px; height:300px; font-size:10pt; font-family: Courier New, monospace">Waiting...</textarea>
        </p>
        <p>
            <strong>Name:</strong> <span id="rs_name">??</span>
        </p>

        <div align="center" id="div_attack">  </div>
        <br />
        <div align="center" id="div_defend">  </div>

        <div align="center">
            <br />
            <button id="submit">Submit</button>
        </div>

<!--
    james: eventually, we will want to use the hosted version of the JQuery library
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
-->
        <script src="jquery-1.9.0.min.js"></script>
        <script>
            $(document).ready(function() {
                // functions
                function addDie(id, rolled_number, parent) {
                    if (document.createElement){
                        var die_div=document.createElement("div");
                        die_div.id=id;
                        $('#'+parent).append(die_div);
                        $('#'+id).addClass("die_img unselected");
                        // next line could theoretically be put into api.css
                        // it is here to remind me of the syntax to alter the css directly
                        $('#'+id).css("background-image", "url('images/d6-2.png')");
                        $('#'+id).text(rolled_number);
                        $('#'+id).click(borderToggle);
                    }
                }

                function ajaxTest() {
                    jQuery.ajax({                                   // Do a jQuery AJAX fetch
                        url: 'json_test_emitter.php',               // Returns a content-type of "application/json" so jQuery knows its a JSON object
                        success: function(rs, status, xhr) {
                            console.log(rs);                        // Debug; show that this is indeed a javascript object, and not just a string
                            $rs = $('#result');
                            if (rs.status == 'ok') {
                                $rs.html("JSON fetch succeeded!\nThe data of the result is:\n"+
                                         JSON.stringify(rs.data));  // Show the result
                                $('#rs_name').html(rs.data.name);   // Grab a specific data element from the result
                            } else {
                                $rs.html("JSON fetch failed\n"+
                                         JSON.stringify(rs.data));  // We got some JSON we didn't expect (the network fetch succeeded, but the engine had an error)
                            }
                        }
                    });
                }

                function borderToggle() {
                    $(this).toggleClass("selected unselected");
                }

                function displayDice() {
                    var dieAttackIdx;
                    var dieDefendIdx;

                    for (dieAttackIdx = 0;
                         dieAttackIdx < dieAttackValues.length;
                         dieAttackIdx++) {
                        addDie('playerIdx_0_dieIdx_' + dieAttackIdx,
                               dieAttackValues[dieAttackIdx],
                               "div_attack");
                    }

                    for (dieDefendIdx = 0;
                         dieDefendIdx < dieDefendValues.length;
                         dieDefendIdx++) {
                        addDie('playerIdx_1_dieIdx_' + dieDefendIdx,
                               dieDefendValues[dieDefendIdx],
                               "div_defend");
                    }
                }

                function loadGameInfo() {
                    dieAttackValues = new Array(5,4,2,6,9);
                    dieDefendValues = new Array(1,3);
                }

                // on-click behaviour
                $('#fetch').click(function() {                      // When the button is clicked...
                    $('#result').html('Fetching...');               // Show that we're doing a network fetch
                    ajaxTest();
                });

                $('#submit').click(function() {
                    var dieText = '';
                    $("div.selected").each(function(index, element) {
                        dieText = dieText + $(element).attr('id') + '\n';
                    })
                    $('#result').html(dieText);
                });

                // code to run when page is ready
                var dieAttackValues;
                var dieDefendValues;

                loadGameInfo();
                displayDice();
            });
        </script>
    </body>
</html>